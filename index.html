<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>Southwood — Signage Schedule Generator</title>
  <link rel="stylesheet" href="./css/styles.css" />
  <link rel="manifest" href="./manifest.webmanifest" />
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><h1>Southwood — Signage Schedule Generator</h1></div>
    <div class="actions">
      <button class="btn" id="btnSave">Save</button>
      <label class="btn">
        <input type="file" id="fileInput" accept="application/pdf,.pdf,image/*" multiple hidden>
        Upload Plan(s)
      </label>
      <button class="btn" id="btnScanPage">Scan This Page</button>
      <button class="btn" id="btnScanAll">Scan All Pages</button>
      <button class="btn primary" id="btnGenerate">Generate Schedule</button>
    </div>
  </header>

  <div class="layout">
    <aside class="left">
      <section class="section">
        <h2>Projects</h2>
        <div class="row">
          <input class="input" id="projectName" placeholder="New project name" />
          <button class="btn" id="btnNew">Add</button>
        </div>
        <div id="projectList" class="list"></div>
      </section>

      <section class="section">
        <h2>Settings</h2>
        <div class="row">
          <input class="input" id="building" placeholder="Building (e.g., B1)" />
          <input class="input" id="level" placeholder="Level (e.g., 1)" />
        </div>
        <div class="row" style="margin-top:8px">
          <select id="rulePreset" class="input">
            <option value="southwood">Southwood Default Rules</option>
            <option value="basic">Basic (generic)</option>
          </select>
          <button class="btn" id="btnExportXLSX">Export XLSX</button>
        </div>
        <details style="margin-top:8px"><summary>Rule summary</summary>
          <ul class="hint">
            <li>Elevators → Callbox + Evac + Hall Direct</li>
            <li>Stairs → Ingress (inside) + Egress (outside)</li>
            <li>Exits only on Level 1</li>
            <li>Electrical/Data → BOH</li>
            <li>Restrooms → FOH</li>
          </ul>
        </details>
      </section>

      <section class="section">
        <h2>Pages</h2>
        <div id="pageList" class="list"></div>
      </section>

      <section class="section">
        <h2>Validation</h2>
        <div id="issues" class="issues"></div>
      </section>
    </aside>

    <main class="right">
      <div class="viewer">
        <div class="status">
          <span class="badge" id="zoomBadge">100%</span>
          <span class="pill" id="pageBadge">—</span>
          <span class="pill" id="scaleBadge">Scale: not set</span>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnZoomOut">−</button>
          <button class="btn" id="btnZoomIn">+</button>
          <button class="btn" id="btnToggleGrid">Grid</button>
          <button class="btn" id="btnScale">Set Scale</button>
          <div class="divider"></div>
          <div class="palette" id="pinPalette"></div>
          <button class="btn" id="btnClearPins">Clear Pins (page)</button>
        </div>
        <div id="stage">
          <canvas id="pageCanvas"></canvas>
        </div>
      </div>

      <section class="schedule">
        <div class="footerBar">
          <div class="inline"><strong>Schedule</strong> <span class="pill" id="rowCount">0 rows</span></div>
          <div class="inline">
            <button class="btn" id="btnAddRow">Add Row</button>
            <button class="btn" id="btnExportCSV">Export CSV</button>
            <button class="btn" id="btnExportXLSX2">Export XLSX</button>
            <button class="btn danger" id="btnClearSchedule">Clear</button>
          </div>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>Sign Type</th><th>Room Number</th><th>Room Name</th>
              <th>Building</th><th>Level</th><th>Notes</th><th></th>
            </tr></thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
        <div class="note">Tip: Use the palette to drop presets fast. Double‑click a pin to edit. Press <kbd>S</kbd> for Stair bundle, <kbd>L</kbd> for Elevator bundle, <kbd>G</kbd> to toggle grid.</div>
      </section>
    </main>
  </div>

  <!-- Vendor libs (local with fallback to CDN) -->
  <script src="./vendor/pdfjs/pdf.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js'"></script>
  <script>
    if (window.pdfjsLib) {
      // Prefer local worker; fall back to CDN if missing
      try { pdfjsLib.GlobalWorkerOptions.workerSrc = './vendor/pdfjs/pdf.worker.min.js'; } catch(e) {}
      if (!pdfjsLib.GlobalWorkerOptions.workerSrc || pdfjsLib.GlobalWorkerOptions.workerSrc.indexOf('vendor')===-1) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js';
      }
    }
  </script>
  <script src="./vendor/tesseract/tesseract.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'"></script>
  <script src="./vendor/xlsx/xlsx.full.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>

  <!-- App modules -->
  <script type="module" src="./js/app.js"></script>

  <!-- PWA: register service worker (safe even on Pages) -->
  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  </script>
</body>
</html>
